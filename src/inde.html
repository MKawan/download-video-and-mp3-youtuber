<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downloader de Vídeos e Playlists do YouTube</title>
    <script src="https://cdn.jsdelivr.net/npm/ytdl-core@latest/dist/ytdl.min.js"></script>
    <script src="https://cdn.pyodide.dev/v0.26.3/full/pyodide.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #playlistFolderGroup, #resolutionGroup {
            display: none;
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Downloader de Vídeos e Playlists</h1>
    <form id="downloadForm">
        <div class="form-group">
            <label for="url">URL do Vídeo ou Playlist:</label>
            <input type="text" id="url" name="url" placeholder="Ex: https://www.youtube.com/watch?v=..." required>
        </div>
        <div class="form-group">
            <label for="mediaType">Tipo de Mídia:</label>
            <select id="mediaType" name="mediaType">
                <option value="video">Vídeo Individual</option>
                <option value="playlist">Playlist</option>
            </select>
        </div>
        <div class="form-group" id="playlistFolderGroup">
            <label for="playlistFolder">Nome da Pasta para Playlist:</label>
            <input type="text" id="playlistFolder" name="playlistFolder" placeholder="Ex: Minha Playlist">
        </div>
        <div class="form-group" id="resolutionGroup">
            <label for="resolution">Resolução:</label>
            <select id="resolution" name="resolution">
                <option value="">Selecione uma resolução</option>
            </select>
        </div>
        <button type="button" id="fetchResolutions">Buscar Resoluções</button>
        <button type="submit" id="downloadButton" disabled>Baixar</button>
    </form>
    <div id="status"></div>

    <script>
        let pyodide;
        let resolutions = [];

        // Inicializa o Pyodide
        async function initPyodide() {
            pyodide = await loadPyodide();
            await pyodide.loadPackage('micropip');
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install('yt-dlp')
            `);
        }

        // Busca resoluções disponíveis usando ytdl-core
        async function fetchResolutions() {
            const url = document.getElementById('url').value;
            const statusDiv = document.getElementById('status');
            const resolutionSelect = document.getElementById('resolution');
            const downloadButton = document.getElementById('downloadButton');

            if (!url) {
                statusDiv.textContent = 'Por favor, insira uma URL válida.';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = 'Buscando resoluções...';
            statusDiv.className = '';

            try {
                const info = await ytdl.getInfo(url);
                resolutions = info.formats
                    .filter(f => f.mimeType.includes('video/mp4') && f.height)
                    .map(f => ({
                        height: f.height,
                        itag: f.itag,
                        label: `${f.height}p`
                    }))
                    .sort((a, b) => b.height - a.height);

                resolutionSelect.innerHTML = '<option value="">Selecione uma resolução</option>';
                resolutions.forEach(res => {
                    const option = document.createElement('option');
                    option.value = res.itag;
                    option.textContent = res.label;
                    resolutionSelect.appendChild(option);
                });

                resolutionSelect.parentElement.style.display = 'block';
                downloadButton.disabled = false;
                statusDiv.textContent = 'Resoluções carregadas com sucesso!';
                statusDiv.className = 'success';
            } catch (error) {
                statusDiv.textContent = `Erro ao buscar resoluções: ${error.message}`;
                statusDiv.className = 'error';
            }
        }

        // Função para baixar o vídeo ou playlist usando yt-dlp
        async function downloadMedia() {
            const url = document.getElementById('url').value;
            const isPlaylist = document.getElementById('mediaType').value === 'playlist';
            const playlistFolder = document.getElementById('playlistFolder').value;
            const itag = document.getElementById('resolution').value;
            const statusDiv = document.getElementById('status');

            statusDiv.textContent = 'Iniciando download...';
            statusDiv.className = '';

            try {
                let format = itag ? `bestvideo[height<=${resolutions.find(r => r.itag == itag).height}][ext=mp4]+bestaudio[ext=m4a]/mp4` : 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/mp4';
                let outputTemplate = isPlaylist && playlistFolder ? `${playlistFolder}/%(title)s.%(ext)s` : '%(title)s.%(ext)s';

                // Executa yt-dlp via Pyodide
                const result = await pyodide.runPythonAsync(`
                    import yt_dlp
                    import io
                    import base64

                    ydl_opts = {
                        'format': '${format}',
                        'outtmpl': '${outputTemplate}',
                        'nocheckcertificate': True,
                        'quiet': True,
                    }
                    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                        info = ydl.extract_info('${url}', download=True)
                        # Simula a saída como base64 para evitar I/O direto
                        with open(ydl.prepare_filename(info), 'rb') as f:
                            return base64.b64encode(f.read()).decode('utf-8')
                `);

                // Converte o resultado base64 para um blob e inicia o download
                const byteCharacters = atob(result);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'video/mp4' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = isPlaylist ? `${playlistFolder || 'playlist'}.zip` : 'video.mp4';
                link.click();

                statusDiv.textContent = 'Download concluído com sucesso!';
                statusDiv.className = 'success';
            } catch (error) {
                statusDiv.textContent = `Erro ao baixar: ${error.message}`;
                statusDiv.className = 'error';
            }
        }

        // Inicializa o Pyodide ao carregar a página
        initPyodide().then(() => {
            console.log('Pyodide inicializado');
        });

        // Evento para alternar visibilidade do campo de nome da pasta
        document.getElementById('mediaType').addEventListener('change', function() {
            document.getElementById('playlistFolderGroup').style.display = this.value === 'playlist' ? 'block' : 'none';
        });

        // Evento para buscar resoluções
        document.getElementById('fetchResolutions').addEventListener('click', fetchResolutions);

        // Evento para iniciar o download
        document.getElementById('downloadForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            await downloadMedia();
        });
    </script>
</body>
</html>